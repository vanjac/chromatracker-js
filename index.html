<!DOCTYPE html>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="src/Module.js"></script>
<script src="src/PeriodTable.js"></script>
<script src="src/ModLoader.js"></script>
<script src="src/Playback.js"></script>

<input id="file-select" type="file"><br>
<button onclick="playFile()">Play File</button><br>
<div>Base latency: <span id="base-latency"></span></div>
<div>Output latency: <span id="output-latency"></span></div>
<div>Active samplers: <span id="samplers"></span></div>

<script>
  const query = s => document.querySelector(s);

  let playback;

  function playFile() {
    /** @type File */
    let file = document.querySelector('#file-select').files[0];
    file.arrayBuffer().then(b => {
      let mod = readModule(b);
      console.log(mod);
      playback = initPlayback(mod);

      let process = () => {
        while (playback.time < playback.ctx.currentTime + 0.5)
          processRow(playback);
      };
      process();
      setInterval(process, 200);

      requestAnimationFrame(update);
    })
  }

  function update() {
    requestAnimationFrame(update);
    query('#base-latency').textContent = playback.ctx.baseLatency * 1000;
    query('#output-latency').textContent = playback.ctx.outputLatency * 1000;
    query('#samplers').textContent = playback.activeSources;
  }
</script>
