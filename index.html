<!DOCTYPE html>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
  body {
    height: 100%;
    overflow: hidden;
    position: fixed;
  }
</style>

<script src="src/Module.js"></script>
<script src="src/PeriodTable.js"></script>
<script src="src/ModLoader.js"></script>
<script src="src/ModWriter.js"></script>
<script src="src/Playback.js"></script>

<div>
  <input id="file-select" type="file">
  <button onclick="loadFile()">Load</button>
  <button onclick="saveFile()">Save</button>
</div>
<div>
  <button onclick="play()">Play</button>
  <button onclick="play(true)">Play from</button>
  <button onclick="stop()">Stop</button>
</div>
<div>Title: <span id="title"></span></div>
<select id="sequence" size="10" style="width:30pt"></select>
<select id="samples" size="10" style="width:130pt"></select>
<div>Row: <input type="number" size="6" id="row"></div>
<div>Tempo: <input type="number" size="6" id="tempo"></div>
<div>Speed: <input type="number" size="6" id="speed"></div>
<div>Active samplers: <span id="samplers"></span></div>
<div>Time: <span id="time"></span></div>
<div>Queued time: <span id="queued"></span></div>
<div>
  <input type="checkbox" onchange="muteCheck(0, this.checked)" checked>
  <input type="checkbox" onchange="muteCheck(1, this.checked)" checked>
  <input type="checkbox" onchange="muteCheck(2, this.checked)" checked>
  <input type="checkbox" onchange="muteCheck(3, this.checked)" checked>
</div>
<div>
  Jam pitch: <input type="number" size="6" value="36" id="jam-pitch">
  <button onmousedown="jamDown(event)" onmouseup="jamUp(event)"
    ontouchstart="jamDown(event)" ontouchend="jamUp(event)">Jam</button>
</div>
<div id="errors">
  Errors:<br>
</div>

<script>
  "use strict";

  const query = s => document.querySelector(s);

  window.onerror = (message, source, line) => {
    query('#errors').insertAdjacentHTML('beforeend',
      `${source}:${line}<br>&nbsp;&nbsp;${message}<br>`);
  };

  let module;
  let context;
  let playback;

  let animHandle;
  let intervalHandle;

  let queuedTime = 0;
  let queuedLines = [];

  function loadFile() {
    /** @type File */
    let files = document.querySelector('#file-select').files;
    if (files.length) {
      readModuleBlob(files[0]);
    } else {
      fetch('https://chroma.zone/share/space_debris.mod').then(
        r => r.blob().then(
          b => readModuleBlob(b)));
    }
  }

  function readModuleBlob(blob) {
    let reader = new FileReader();
    reader.onload = () => {
      module = readModule(reader.result);
      console.log(module);

      query('#title').textContent = module.name;

      let seqElem = query('#sequence');
      seqElem.textContent = '';
      for (let [i, pos] of module.sequence.entries()) {
        let option = document.createElement('option')
        option.textContent = pos;
        seqElem.appendChild(option);
      }

      let samplesElem = query('#samples');
      samplesElem.textContent = '';
      for (let [i, sample] of module.samples.entries()) {
        let option = document.createElement('option')
        option.textContent = i + ': ' + (sample ? sample.name : '(none)');
        samplesElem.appendChild(option);
      }

      play();
    };
    reader.readAsArrayBuffer(blob);
  }

  function saveFile() {
    let blob = new Blob([writeModule(module)], {type: 'application/octet-stream'});
    window.open(URL.createObjectURL(blob));
  }

  function play(resume) {
    if (!module)
      return;
    if (!context) {
      let AudioContext = window.AudioContext || window.webkitAudioContext;
      context = new AudioContext({latencyHint: 'interactive'});
    }
    // for iOS:
    context.resume().then(() => {
      if (intervalHandle)
        stop();
      playback = initPlayback(context, module);
      if (resume) {
        playback.pos = query('#sequence').selectedIndex;
        if (playback.pos == -1) playback.pos = 0;
        playback.row = query('#row').valueAsNumber;
        playback.tempo = query('#tempo').valueAsNumber;
        playback.speed = query('#speed').valueAsNumber;
      }

      let process = () => {
        while (queuedTime < context.currentTime + 0.5) {
          queuedTime = playback.time;
          let {pos, row} = playback;
          processRow(playback);
          let {tempo, speed} = playback;
          queuedLines.push({time: queuedTime, pos, row, tempo, speed});
        }
        query('#queued').textContent = queuedTime.toFixed(3);
      };
      process();
      intervalHandle = setInterval(process, 200);

      animHandle = requestAnimationFrame(update);
    })
  }

  function stop() {
    if (intervalHandle) {
      stopPlayback(playback);
      clearInterval(intervalHandle);
      cancelAnimationFrame(animHandle);
      queuedLines = [];
      queuedTime = 0;
      intervalHandle = null;
    }
  }

  function muteCheck(channel, checked) {
    if (playback)
      setChannelMute(playback, channel, !checked);
  }

  function jamDown(e) {
    e.preventDefault();
    if (playback) {
      let s = query('#samples').selectedIndex;
      if (s > 0)
        jamPlay(playback, s, query('#jam-pitch').valueAsNumber);
    }
  }

  function jamUp(e) {
    e.preventDefault();
    if (playback)
      jamRelease(playback);
  }

  function update() {
    animHandle = requestAnimationFrame(update);

    let curTime = context.currentTime;
    if (context.outputLatency) // if supported
      curTime -= context.outputLatency;
    if (queuedLines.length) {
      let i = 0;
      while (i < (queuedLines.length - 1) && queuedLines[i + 1].time <= curTime)
        i++;
      queuedLines.splice(0, i);
      let curLine = queuedLines[0];
      query('#sequence').selectedIndex = curLine.pos;
      query('#row').value = curLine.row;
      query('#tempo').value = curLine.tempo;
      query('#speed').value = curLine.speed;
    }
    let activeSources = 0;
    for (let channel of playback.channels)
      activeSources += channel.activeSources.size;
    query('#samplers').textContent = activeSources;
    query('#time').textContent = context.currentTime.toFixed(3);
  }
</script>
