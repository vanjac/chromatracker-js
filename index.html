<!DOCTYPE html>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="src/Module.js"></script>
<script src="src/PeriodTable.js"></script>
<script src="src/ModLoader.js"></script>
<script src="src/Playback.js"></script>

<input id="file-select" type="file"><br>
<button onclick="playFile()">Play File</button>
<button onclick="stop()">Stop</button><br>
<div>Pos: <span id="pos"></span></div>
<div>Pat: <span id="pat"></span></div>
<div>Row: <span id="row"></span></div>
<div>Tempo: <span id="tempo"></span></div>
<div>Speed: <span id="speed"></span></div>
<div>Active samplers: <span id="samplers"></span></div>

<script>
  "use strict";

  const query = s => document.querySelector(s);

  let animHandle;
  let intervalHandle;

  let context;
  let playback;
  let queuedLines = [];

  function playFile() {
    /** @type File */
    let file = document.querySelector('#file-select').files[0];
    file.arrayBuffer().then(b => {
      let mod = readModule(b);
      console.log(mod);
      context = new AudioContext({latencyHint: 'playback'});
      playback = initPlayback(context, mod);

      let process = () => {
        while (playback.time < context.currentTime + 0.5) {
          let {time, pos, row} = playback;
          processRow(playback);
          let {tempo, speed} = playback;
          queuedLines.push({time, pos, row, tempo, speed});
        }
      };
      process();
      intervalHandle = setInterval(process, 200);

      animHandle = requestAnimationFrame(update);
    })
  }

  function stop() {
    clearInterval(intervalHandle);
    cancelAnimationFrame(animHandle);
    context.close();
    queuedLines = [];
  }

  function update() {
    animHandle = requestAnimationFrame(update);

    if (queuedLines.length) {
      let i = 0;
      while (i < (queuedLines.length - 1) && queuedLines[i + 1].time <= context.currentTime)
        i++;
      queuedLines.splice(0, i);
      let curLine = queuedLines[0];
      query('#pos').textContent = curLine.pos;
      query('#pat').textContent = playback.mod.sequence[curLine.pos];
      query('#row').textContent = curLine.row;
      query('#tempo').textContent = curLine.tempo;
      query('#speed').textContent = curLine.speed;
    }
    query('#samplers').textContent = playback.activeSources;
  }
</script>
